@page "/"
@rendermode InteractiveServer
@implements IAsyncDisposable
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation

<PageTitle>Home</PageTitle>

<div class="page-shell">
    <div class="terminal-hero">
        <div class="terminal-card" data-label="/landing">
            <p class="tag">welcome</p>
            <h1 class="hero-title">MooSharp is a living terminal world.</h1>
            <p class="lede">
                Connect, register, and roam a multiplayer text realm. Chat with others and interact with AI
                agents that keep the world humming even when you're offline.
            </p>
            <div class="actions">
                <button class="btn btn-accent" @onclick="NavigateToGame">Launch client</button>
            </div>
            <div class="stat-line">
                <span>Players online: @(_playerCount?.ToString() ?? "â€”")</span>
                <span>@_statusMessage</span>
            </div>
        </div>

        <div class="terminal-card" data-label="/system-log">
            <ul class="list-reset">
                <li>
                    <strong>Classic MOO gameplay</strong>
                    <span>Talk to people, collect Precious Gems, and create your own rooms.</span>
                </li>
                <li>
                    <strong>Realtime interaction</strong>
                    <span>Chat, explore, and talk with other players seamlessly.</span>
                </li>
                <li>
                    <strong>Agents in the loop</strong>
                    <span>AI agents roam the world with their own personalities and goals.</span>
                </li>
            </ul>
        </div>
    </div>

    <div class="info-grid">
        <div class="info-card">
            <p class="tag">quickstart</p>
            <h2>How do I play?</h2>
            <p>
                Head to the game page, choose a username and password, then issue commands. Your inventory and discoveries
                persist between logins. Use '/help' to see all available commands.
            </p>
        </div>
        <div class="info-card">
            <p class="tag">activity</p>
            <h2>News and updates</h2>
            <p>v1.00 - initial public release</p>
        </div>
    </div>
</div>

@code {
    private int? _playerCount;
    private string _statusMessage = "Loading...";
    private CancellationTokenSource? _pollingCts;
    private static readonly TimeSpan PlayerCountInterval = TimeSpan.FromSeconds(5);

    protected override async Task OnInitializedAsync()
    {
        _pollingCts = new();

        await RefreshPlayerCountAsync(_pollingCts.Token);
        _ = PollPlayerCountAsync(_pollingCts.Token);
    }

    private async Task RefreshPlayerCountAsync(CancellationToken cancellationToken)
    {
        try
        {
            var client = HttpClientFactory.CreateClient();

            client.BaseAddress ??= new(Navigation.BaseUri);

            var response = await client.GetFromJsonAsync<PlayerCountResponse>("api/player-count", cancellationToken);

            _playerCount = response?.Count ?? 0;
            _statusMessage = "Live players connected";
        }
        catch (OperationCanceledException)
        {
            // Ignore cancellations during disposal.
        }
        catch (Exception)
        {
            _statusMessage = "Unable to load player count right now.";
        }
    }

    private async Task PollPlayerCountAsync(CancellationToken cancellationToken)
    {
        try
        {
            while (!cancellationToken.IsCancellationRequested)
            {
                await Task.Delay(PlayerCountInterval, cancellationToken);
                await RefreshPlayerCountAsync(cancellationToken);
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (OperationCanceledException)
        {
            // Expected during teardown.
        }
    }

    private void NavigateToGame() => Navigation.NavigateTo("/game");

    public ValueTask DisposeAsync()
    {
        _pollingCts?.Cancel();
        _pollingCts?.Dispose();

        return ValueTask.CompletedTask;
    }

    private sealed record PlayerCountResponse(int Count);
}
